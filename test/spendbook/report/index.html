<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="../styles.css" />
  </head>

  <body>
  <dotlottie-player src="https://lottie.host/31eb8f50-5493-47de-939a-adffa6bd4317/wbaxE0xVId.json" background="transparent" speed="1" style="width: 100%; height: 200px; text-align: center;" loop autoplay></dotlottie-player>

  <form class="form">
    <div class="field-wrapper">
      <span class="label">Категория</span>
      <button class="select-button" type="button">Категория</button>
    </div>
    <ul id="custom-dropdown" class="select-options"></ul>

    <label class="hidden-input-label" for="select-value">
      <input id="select-value" class="hidden-input" type="text" name="select-category" value=""/>
    </label>

      <div class="field-wrapper">
          <span class="label">Год</span>
          <div class="radiobtn">
              <input type="radio" id="huey"
                     name="year" value="2024" checked />
              <label for="huey">2024</label>
          </div>

          <div class="radiobtn">
              <input type="radio" id="dewey"
                     name="year" value="2023" />
              <label for="dewey">2023</label>
          </div>

          <div class="radiobtn">
              <input type="radio" id="louie"
                     name="year" value="2022" />
              <label for="louie">2022</label>
          </div>
      </div>
  </form>
  </body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script>
  <script src="../js/dropDowns.js"></script>
  <script>
    $(document).ready(function () {
      const dropdownButton = $('.select-button')
      const dropdownMenu = $('.select-options')
      const dropdownInput = $('.hidden-input')

      dropdownButton.on('click', function () {
        dropdownMenu.toggleClass('select-options-visible');
        $(this).toggleClass('dropdown__button_active');
      });

      $(document).on('keydown', function (e) {
        if( e.key === 'Tab' || e.key === 'Escape' ) {
          dropdownButton.removeClass('dropdown__button_active');
          dropdownMenu.removeClass('select-options-visible');
        }
      })

      $.each(months, function (key, obj) {
        // $("#month").append(`<option class="select-option" value="${obj.value}">${obj.text}</option>`);
        $("#custom-dropdown").append(`<option class="select-option" value="${obj.value}">${obj.text}</option>`);
      });

      $(document).on('click', '.select-option', function() {
        $('.select-options .select-option').each(function (){
          if ($(this).hasClass('selected')) {
            $(this).removeClass('selected')
          }
        })

        $(this).addClass('selected')
        dropdownButton.html($(this).text())
        dropdownInput.val($(this).attr('value'))
        dropdownMenu.removeClass('select-options-visible')

        collectData()
      });


      function collectData() {
        const data = {
          month: parseInt(dropdownInput.val(), 10),
          year: parseInt($('input[name="year"]:checked').val(), 10),
        };
        Object.keys(data).forEach(
          (key) =>
            (data[key] =
              data[key] === "any" || data[key] === "" ? null : data[key])
        );

          console.log($('input[name="year"]:checked').val())
        return data;
      }

      // $("#year").on("click", collectData);
      dropdownInput.val(new Date().getMonth()+1);

      const m = new Date().getMonth()+1

      const currentMonth = months.find((item) => item.value === m.toString())

      dropdownButton.html(currentMonth.text)

      const mainButton = window.Telegram.WebApp.MainButton;
      mainButton.text = "Получить отчет";
      mainButton.enable();
      mainButton.show();
      mainButton.onClick(function () {
        window.Telegram.WebApp.sendData(JSON.stringify(collectData()));
      });
    });
  </script>
</html>
